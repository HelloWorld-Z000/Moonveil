scriptName MoonlightKeyDetect extends ActiveMagicEffect

spell property SpellRelease auto
spell property SpellReleaseDirection auto
spell property SpellProjectileH Auto
spell property SpellProjectileV Auto
Actor MoonlightActor

Int MKDCount = 0
Float MKDtime = 1.00000

event OnEffectStart(actor akTarget, actor akCaster)
    MoonlightActor = akTarget
    self.RegisterForControl("Left Attack/Block")
    self.RegisterForControl("Right Attack/Block")

endevent

event OnEffectFinish(actor akTarget, actor akCaster)
    MoonlightActor = akTarget
    self.UnRegisterForControl("Left Attack/Block")
    self.UnRegisterForControl("Right Attack/Block")

endevent

event OnUpdate()

    MKDCount += 1
    if MKDCount == 1
            self.RegisterForSingleUpdate(MKDtime)
        elseIf MKDCount == 2
            MKDCount == 0
            self.RegisterForSingleUpdate(0)
        endIf
endevent

event OnControlDown(String Control)

    if Control == "Left Attack/Block" || Control == "Right Attack/Block" && MKDCount == 0
        MKDCount = 0
        self.RegisterForSingleUpdate(0 as Float)
        MoonlightActor.DispelSpell(SpellReleaseDirection)
    elseif Control == "Left Attack/Block" || Control == "Right Attack/Block" && MKDCount == 1     
        SpellReleaseDirection.Cast(MoonlightActor)
        self.RegisterForSingleUpdate(0 as Float)
    endif
endevent    
    
event OnControlUp(String Control, Float HoldTime)

    if Control == "Left Attack/Block" || Control == "Right Attack/Block"
        SpellRelease.Cast(MoonlightActor)
        MKDCount = 0
    endIf
endevent

event OnAnimationEvent(ObjectReference akSource, string asEventName)
    if asEventName == "SoundPlay.WPNSwingBladeMedium" && MKDCount == 0
            Cut.Cast(Player)
            CutSFX.Play(Player)
        else
            Player.removeSpell(Targetspell)
        endif   
endevent