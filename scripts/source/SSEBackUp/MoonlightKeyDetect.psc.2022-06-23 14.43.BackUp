scriptName MoonlightKeyDetect extends ActiveMagicEffect

spell property SpellRelease auto
spell property SpellReleaseDirection auto
spell property SpellProjectileH Auto
spell property SpellProjectileV Auto
Actor MoonlightActor

Int MKDCount = 0
Float MKDtime = 1.00000

event OnEffectStart(actor akTarget, actor akCaster)
    MoonlightActor = akTarget
    UnRegisterForControl("Right Attack/Block")   
    RegisterForAnimationEvent(MoonlightActor, "weaponSwing")

endevent

event OnEffectFinish(actor akTarget, actor akCaster)
    UnRegisterForAnimationEvent(MoonlightActor, "weaponSwing")
    MoonlightActor = None
endevent

event OnUpdate()

    MKDCount += 1
    if MKDCount == 1
            self.RegisterForSingleUpdate(MKDtime)
        elseIf MKDCount == 2
            MKDCount == 0
            self.RegisterForSingleUpdate(0)
        endIf
endevent

event OnControlDown(String Control)

    if Control == "Right Attack/Block" && MKDCount == 0
        MKDCount = 0
        self.RegisterForSingleUpdate(0 as Float)
        MoonlightActor.DispelSpell(SpellReleaseDirection)
    elseif Control == "Right Attack/Block" && MKDCount == 1     
        SpellReleaseDirection.Cast(MoonlightActor)
        self.RegisterForSingleUpdate(0 as Float)
    endif
endevent    
    
event OnControlUp(String Control, Float HoldTime)

    if Control == "Right Attack/Block"
        SpellRelease.Cast(MoonlightActor)
        MKDCount = 0
    endIf
endevent

event OnAnimationEvent(ObjectReference akSource, string asEventName)
    if asEventName == "weaponSwing" && MKDCount == 0
        SpellProjectileH.Cast(MoonlightActor)
    ElseIf asEventName == "weaponSwing" && MKDCount == 1
        SpellProjectileV.Cast(MoonlightActor)
    endif   
endevent